<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="cyphr">
<title>Data Encryption • cyphr</title>
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://docs.ropensci.org/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Data Encryption">
<meta property="og:description" content="cyphr">
<meta property="og:image" content="https://docs.ropensci.org/cyphr/logo.png">
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Matomo --><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
<script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
<!-- End Matomo Code -->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">cyphr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.1.5</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="nav-link" href="../articles/cyphr.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/data.html">Data Encryption</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ropensci/cyphr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Data Encryption</h1>
                        <h4 data-toc-skip class="author">Rich FitzJohn</h4>
            
            <h4 data-toc-skip class="date">2024-03-18</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/cyphr/blob/HEAD/vignettes/data.Rmd" class="external-link"><code>vignettes/data.Rmd</code></a></small>
      <div class="d-none name"><code>data.Rmd</code></div>
    </div>

    
    
<p><strong>The scenario:</strong></p>
<p>A group of people are working on a sensitive data set that for practical reasons needs to be stored in a place that we’re not 100% happy with the security (e.g., Dropbox), or we’re concerned that files stored in plain text on users computers (e.g. laptops) may lead to the data being compromised.</p>
<p>If the data can be stored encrypted but everyone in the group can still read and write the data then we’ve improved the situation somewhat. But organising for everyone to get a copy of the key to decrypt the data files is non-trivial. The workflow described here aims to simplify this procedure using lower-level functions in the <code>cyphr</code> package.</p>
<p>The general procedure is this:</p>
<ol style="list-style-type: decimal">
<li><p>A person will set up a set of personal keys and a key for the data. The data key will be encrypted with their personal key so they have access to the data but nobody else does. At this point the data can be encrypted.</p></li>
<li><p>Additional users set up personal keys and request access to the data. Anyone with access to the data can grant access to anyone else.</p></li>
</ol>
<p>Before doing any of this, everyone needs to have ssh keys set up. By default the package will use your ssh keys found at “~/.ssh”; see the main package vignette for how to use this.</p>
<p>For clarity here we will generate two sets of key pairs for two actors Alice and Bob:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path_key_alice</span> <span class="op">&lt;-</span> <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/ssh_keygen.html">ssh_keygen</a></span><span class="op">(</span>password <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">path_key_bob</span> <span class="op">&lt;-</span> <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/ssh_keygen.html">ssh_keygen</a></span><span class="op">(</span>password <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>These would ordinarily be on different machines (nobody has access to anyone else’s private key) and they would be password protected. In the function calls below, all the <code>path_user</code> arguments would be omitted.</p>
<p>We’ll store data in the directory <code>data</code>; at present there is nothing there (this is in a temporary directory for compliance with CRAN policies but would ordinarily be somewhere persistent and under version control ideally).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_dir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"data"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">data_dir</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">data_dir</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## character(0)</span></span></code></pre>
<p><strong>First</strong>, create a personal set of keys. These will be shared across all projects and stored away from the data. Ideally one would do this with <code>ssh-keygen</code> at the command line, following one of the many guides available. A utility function <code>ssh_keygen</code> (which simply calls <code>ssh-keygen</code> for you) is available in this package though. You will need to generate a key on each computer you want access from. Don’t copy the key around. If you lose your user key you will lose access to the data!</p>
<p><strong>Second</strong>, create a key for the data and encrypt that key with your personal key. Note that the data key is never stored directly - it is always stored encrypted by a personal key.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_admin.html">data_admin_init</a></span><span class="op">(</span><span class="va">data_dir</span>, path_user <span class="op">=</span> <span class="va">path_key_alice</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Generating data key</span></span></code></pre>
<pre><code><span><span class="co">## Authorising ourselves</span></span></code></pre>
<pre><code><span><span class="co">## Adding key 33:69:2f:4b:b3:9a:23:d5:fe:f0:e0:e6:a9:8e:2c:ce:91:b1:a3:f0:89:65:54:b0:32:5f:6e:d1:5a:54:1b:5e</span></span>
<span><span class="co">##   user: root</span></span>
<span><span class="co">##   host: 8d8641327ce4</span></span>
<span><span class="co">##   date: 2024-03-18 05:40:11.01126</span></span></code></pre>
<pre><code><span><span class="co">## Verifying</span></span></code></pre>
<p>The data key is very important. If it is deleted, then the data cannot be decrypted. So do not delete the directory <code>data_dir/.cyphr</code>! Ideally add it to your version control system so that it cannot be lost. Of course, if you’re working in a group, there are multiple copies of the data key (each encrypted with a different person’s personal key) which reduces the chance of total loss.</p>
<p>This command can be run multiple times safely; if it detects it has been rerun and the data key will not be regenerated.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_admin.html">data_admin_init</a></span><span class="op">(</span><span class="va">data_dir</span>, path_user <span class="op">=</span> <span class="va">path_key_alice</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Already set up at /tmp/Rtmpnnq6t9/data</span></span></code></pre>
<pre><code><span><span class="co">## Verifying</span></span></code></pre>
<p><strong>Third</strong>, you can add encrypted data to the directory (or to anywhere really). When run, <code>cyphr::config_data</code> will verify that it can actually decrypt things.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_user.html">data_key</a></span><span class="op">(</span><span class="va">data_dir</span>, path_user <span class="op">=</span> <span class="va">path_key_alice</span><span class="op">)</span></span></code></pre></div>
<p>This object can be used with all the <code>cyphr</code> functions (see the “cyphr” vignette; <code><a href="../articles/cyphr.html">vignette("cyphr")</a></code>)</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">filename</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">"iris.rds"</span><span class="op">)</span></span>
<span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/encrypt.html">encrypt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">filename</span><span class="op">)</span>, <span class="va">key</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">data_dir</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "iris.rds"</span></span></code></pre>
<p>The file is encrypted and so cannot be read with <code>readRDS</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in readRDS(filename): unknown input format</span></span></code></pre>
<p>But we can decrypt and read it:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/encrypt.html">decrypt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span>, <span class="va">key</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co">## 1          5.1         3.5          1.4         0.2  setosa</span></span>
<span><span class="co">## 2          4.9         3.0          1.4         0.2  setosa</span></span>
<span><span class="co">## 3          4.7         3.2          1.3         0.2  setosa</span></span>
<span><span class="co">## 4          4.6         3.1          1.5         0.2  setosa</span></span>
<span><span class="co">## 5          5.0         3.6          1.4         0.2  setosa</span></span>
<span><span class="co">## 6          5.4         3.9          1.7         0.4  setosa</span></span></code></pre>
<p><strong>Fourth</strong>, have someone else join in. Recall that to simulate another person here, I’m going to pass an argument <code>path_user = path_key_bob</code> though to the functions. This contains the path to “Bob”’s ssh keypair. If run on an actually different computer this would not be needed; this is just to simulate two users in a single session for this vignette (see minimal example below where this is simulated). Again, typically this user would also not use the <code><a href="../reference/ssh_keygen.html">cyphr::ssh_keygen</a></code> function but use the <code>ssh-keygen</code> command from their shell.</p>
<p>We’re going to assume that the user can read and write to the data. This is the case for my use case where the data are stored on dropbox and will be the case with GitHub based distribution, though there would be a pull request step in here.</p>
<p>This user cannot read the data, though trying to will print a message explaining how you might request access:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">key_bob</span> <span class="op">&lt;-</span> <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_user.html">data_key</a></span><span class="op">(</span><span class="va">data_dir</span>, path_user <span class="op">=</span> <span class="va">path_key_bob</span><span class="op">)</span></span></code></pre></div>
<p>But <code>bob</code> is your collaborator and needs access! What they need to do is run:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_user.html">data_request_access</a></span><span class="op">(</span><span class="va">data_dir</span>, path_user <span class="op">=</span> <span class="va">path_key_bob</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## A request has been added</span></span></code></pre>
<pre><code><span><span class="co">## Email someone with access to add you</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     hash: 4c:ed:14:00:77:4b:47:a9:5a:cc:8a:2f:ef:bb:66:ae:64:2c:bb:e5:f7:ca:05:20:fb:ab:4c:49:60:0c:cb:2a</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## If you are using git, you will need to commit and push first:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     git add .cyphr</span></span>
<span><span class="co">##     git commit -m "Please add me to the dataset"</span></span>
<span><span class="co">##     git push</span></span></code></pre>
<p>(again, ordinarily you would not need the <code>bob</code> bit here)</p>
<p>The user should the send an email to someone with access and quote the hash in the message above.</p>
<p><strong>Fifth</strong>, back on the first computer we can authorise the second user. First, see who has requested access:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">req</span> <span class="op">&lt;-</span> <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_admin.html">data_admin_list_requests</a></span><span class="op">(</span><span class="va">data_dir</span><span class="op">)</span></span>
<span><span class="va">req</span></span></code></pre></div>
<pre><code><span><span class="co">## 1 key:</span></span>
<span><span class="co">##   4c:ed:14:00:77:4b:47:a9:5a:cc:8a:2f:ef:bb:66:ae:64:2c:bb:e5:f7:ca:05:20:fb:ab:4c:49:60:0c:cb:2a</span></span>
<span><span class="co">##     user: root</span></span>
<span><span class="co">##     host: 8d8641327ce4</span></span>
<span><span class="co">##     date: 2024-03-18 05:40:11.487447</span></span></code></pre>
<p>We can see the same hash here as above (<code>4ced1400774b47a95acc8a2fefbb66ae642cbbe5f7ca0520fbab4c49600ccb2a</code>)</p>
<p>…and then grant access to them with the <code><a href="../reference/data_admin.html">cyphr::data_admin_authorise</a></code> function.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_admin.html">data_admin_authorise</a></span><span class="op">(</span><span class="va">data_dir</span>, yes <span class="op">=</span> <span class="cn">TRUE</span>, path_user <span class="op">=</span> <span class="va">path_key_alice</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## There is 1 request for access</span></span></code></pre>
<pre><code><span><span class="co">## Adding key 4c:ed:14:00:77:4b:47:a9:5a:cc:8a:2f:ef:bb:66:ae:64:2c:bb:e5:f7:ca:05:20:fb:ab:4c:49:60:0c:cb:2a</span></span>
<span><span class="co">##   user: root</span></span>
<span><span class="co">##   host: 8d8641327ce4</span></span>
<span><span class="co">##   date: 2024-03-18 05:40:11.487447</span></span></code></pre>
<pre><code><span><span class="co">## Added 1 key</span></span></code></pre>
<pre><code><span><span class="co">## If you are using git, you will need to commit and push:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     git add .cyphr</span></span>
<span><span class="co">##     git commit -m "Authorised root"</span></span>
<span><span class="co">##     git push</span></span></code></pre>
<p>If you do not specify <code>yes = TRUE</code> will prompt for confirmation at each key added.</p>
<p>This has cleared the request queue:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_admin.html">data_admin_list_requests</a></span><span class="op">(</span><span class="va">data_dir</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## (empty)</span></span></code></pre>
<p>and added it to our set of keys:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_admin.html">data_admin_list_keys</a></span><span class="op">(</span><span class="va">data_dir</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 2 keys:</span></span>
<span><span class="co">##   33:69:2f:4b:b3:9a:23:d5:fe:f0:e0:e6:a9:8e:2c:ce:91:b1:a3:f0:89:65:54:b0:32:5f:6e:d1:5a:54:1b:5e</span></span>
<span><span class="co">##     user: root</span></span>
<span><span class="co">##     host: 8d8641327ce4</span></span>
<span><span class="co">##     date: 2024-03-18 05:40:11.01126</span></span>
<span><span class="co">##   4c:ed:14:00:77:4b:47:a9:5a:cc:8a:2f:ef:bb:66:ae:64:2c:bb:e5:f7:ca:05:20:fb:ab:4c:49:60:0c:cb:2a</span></span>
<span><span class="co">##     user: root</span></span>
<span><span class="co">##     host: 8d8641327ce4</span></span>
<span><span class="co">##     date: 2024-03-18 05:40:11.487447</span></span></code></pre>
<p><strong>Finally</strong>, as soon as the authorisation has happened, the user can encrypt and decrypt files:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">key_bob</span> <span class="op">&lt;-</span> <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_user.html">data_key</a></span><span class="op">(</span><span class="va">data_dir</span>, path_user <span class="op">=</span> <span class="va">path_key_bob</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/encrypt.html">decrypt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span>, <span class="va">key_bob</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co">## 1          5.1         3.5          1.4         0.2  setosa</span></span>
<span><span class="co">## 2          4.9         3.0          1.4         0.2  setosa</span></span>
<span><span class="co">## 3          4.7         3.2          1.3         0.2  setosa</span></span>
<span><span class="co">## 4          4.6         3.1          1.5         0.2  setosa</span></span>
<span><span class="co">## 5          5.0         3.6          1.4         0.2  setosa</span></span>
<span><span class="co">## 6          5.4         3.9          1.7         0.4  setosa</span></span></code></pre>
<div class="section level2">
<h2 id="minimal-example">Minimal example<a class="anchor" aria-label="anchor" href="#minimal-example"></a>
</h2>
<p>As above, but with less discussion:</p>
<p>Setup, on Alice’s computer:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_admin.html">data_admin_init</a></span><span class="op">(</span><span class="va">data_dir</span>, path_user <span class="op">=</span> <span class="va">path_key_alice</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Generating data key</span></span></code></pre>
<pre><code><span><span class="co">## Authorising ourselves</span></span></code></pre>
<pre><code><span><span class="co">## Adding key 33:69:2f:4b:b3:9a:23:d5:fe:f0:e0:e6:a9:8e:2c:ce:91:b1:a3:f0:89:65:54:b0:32:5f:6e:d1:5a:54:1b:5e</span></span>
<span><span class="co">##   user: root</span></span>
<span><span class="co">##   host: 8d8641327ce4</span></span>
<span><span class="co">##   date: 2024-03-18 05:40:11.960834</span></span></code></pre>
<pre><code><span><span class="co">## Verifying</span></span></code></pre>
<p>Get the data key key:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_user.html">data_key</a></span><span class="op">(</span><span class="va">data_dir</span>, path_user <span class="op">=</span> <span class="va">path_key_alice</span><span class="op">)</span></span></code></pre></div>
<p>Encrypt a file:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/encrypt.html">encrypt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">iris</span>, <span class="va">filename</span><span class="op">)</span>, <span class="va">key</span><span class="op">)</span></span></code></pre></div>
<p>Request access, on Bob’s computer:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hash</span> <span class="op">&lt;-</span> <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_user.html">data_request_access</a></span><span class="op">(</span><span class="va">data_dir</span>, path_user <span class="op">=</span> <span class="va">path_key_bob</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## A request has been added</span></span></code></pre>
<pre><code><span><span class="co">## Email someone with access to add you</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     hash: 4c:ed:14:00:77:4b:47:a9:5a:cc:8a:2f:ef:bb:66:ae:64:2c:bb:e5:f7:ca:05:20:fb:ab:4c:49:60:0c:cb:2a</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## If you are using git, you will need to commit and push first:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     git add .cyphr</span></span>
<span><span class="co">##     git commit -m "Please add me to the dataset"</span></span>
<span><span class="co">##     git push</span></span></code></pre>
<p>Alice authorises this request::</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_admin.html">data_admin_authorise</a></span><span class="op">(</span><span class="va">data_dir</span>, yes <span class="op">=</span> <span class="cn">TRUE</span>, path_user <span class="op">=</span> <span class="va">path_key_alice</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## There is 1 request for access</span></span></code></pre>
<pre><code><span><span class="co">## Adding key 4c:ed:14:00:77:4b:47:a9:5a:cc:8a:2f:ef:bb:66:ae:64:2c:bb:e5:f7:ca:05:20:fb:ab:4c:49:60:0c:cb:2a</span></span>
<span><span class="co">##   user: root</span></span>
<span><span class="co">##   host: 8d8641327ce4</span></span>
<span><span class="co">##   date: 2024-03-18 05:40:12.161059</span></span></code></pre>
<pre><code><span><span class="co">## Added 1 key</span></span></code></pre>
<pre><code><span><span class="co">## If you are using git, you will need to commit and push:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     git add .cyphr</span></span>
<span><span class="co">##     git commit -m "Authorised root"</span></span>
<span><span class="co">##     git push</span></span></code></pre>
<p>Bob can get the data key:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_user.html">data_key</a></span><span class="op">(</span><span class="va">data_dir</span>, path_user <span class="op">=</span> <span class="va">path_key_bob</span><span class="op">)</span></span></code></pre></div>
<p>Bob can read the secret data:</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/encrypt.html">decrypt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">filename</span><span class="op">)</span>, <span class="va">key</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species</span></span>
<span><span class="co">## 1          5.1         3.5          1.4         0.2  setosa</span></span>
<span><span class="co">## 2          4.9         3.0          1.4         0.2  setosa</span></span>
<span><span class="co">## 3          4.7         3.2          1.3         0.2  setosa</span></span>
<span><span class="co">## 4          4.6         3.1          1.5         0.2  setosa</span></span>
<span><span class="co">## 5          5.0         3.6          1.4         0.2  setosa</span></span>
<span><span class="co">## 6          5.4         3.9          1.7         0.4  setosa</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="details-disclosure">Details &amp; disclosure<a class="anchor" aria-label="anchor" href="#details-disclosure"></a>
</h2>
<p>Encryption does not work through security through obscurity; it works because we can rely on the underlying maths enough to be open about how things are stored and where.</p>
<p>Most encryption libraries require some degree of security in the underlying software. Because of the way R works this is very difficult to guarantee; it is trivial to rewrite code in running packages to skip past verification checks. So this package is <em>not</em> designed to (or able to) avoid exploits in your running code; an attacker could intercept your private keys, the private key to the data, or skip the verification checks that are used to make sure that the keys you load are what they say they are. However, the <em>data</em> are safe; only people who have keys to the data will be able to read it.</p>
<p><code>cyphr</code> uses two different encryption algorithms; it uses RSA encryption via the <code>openssl</code> package for user keys, because there is a common file format for these keys so it makes user configuration easier. It uses the modern sodium package (and through that the libsodium library) for data encryption because it is very fast and simple to work with. This does leave two possible points of weakness as a vulnerability in either of these libraries could lead to an exploit that could allow decryption of your data.</p>
<p>Each user has a public/private key pair. Typically this is in <code>~/.ssh/id_rsa.pub</code> and <code>~/.ssh/id_rsa</code>, and if found these will be used. Alternatively the location of the keypair can be stored elsewhere and pointed at with the <code>USER_KEY</code> or <code>USER_PUBKEY</code> environment variables. The key may be password protected (and this is recommended!) and the password will be requested without ever echoing it to the terminal.</p>
<p>The data directory has a hidden directory <code>.cyphr</code> in it.</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="va">data_dir</span>, all.files <span class="op">=</span> <span class="cn">TRUE</span>, no.. <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] ".cyphr"   "iris.rds"</span></span></code></pre>
<p>This does not actually need to be stored with the data but it makes sense to (there are workflows where data is stored remotely where storing this directory might make sense). The “keys” directory contains a number of files; one for each person who has access to the data.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">".cyphr"</span>, <span class="st">"keys"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "33692f4bb39a23d5fef0e0e6a98e2cce91b1a3f0896554b0325f6ed15a541b5e"</span></span>
<span><span class="co">## [2] "4ced1400774b47a95acc8a2fefbb66ae642cbbe5f7ca0520fbab4c49600ccb2a"</span></span></code></pre>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_admin.html">data_admin_list_keys</a></span><span class="op">(</span><span class="va">data_dir</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "33692f4bb39a23d5fef0e0e6a98e2cce91b1a3f0896554b0325f6ed15a541b5e"</span></span>
<span><span class="co">## [2] "4ced1400774b47a95acc8a2fefbb66ae642cbbe5f7ca0520fbab4c49600ccb2a"</span></span></code></pre>
<p>(the file <code>test</code> is a small file encrypted with the data key used to verify everything is working OK).</p>
<p>Each file is stored in RDS format and is a list with elements:</p>
<ul>
<li>user: the reported user name of the person who created request for data</li>
<li>host: the reported computer name</li>
<li>date: the time the request was generated</li>
<li>pub: the RSA public key of the user</li>
<li>key: the data key, encrypted with the user key. Without the private key, this cannot be used. With the user’s private key this can be used to generate the symmetric key to the data.</li>
</ul>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu">cyphr</span><span class="fu">::</span><span class="fu"><a href="../reference/data_admin.html">data_admin_list_keys</a></span><span class="op">(</span><span class="va">data_dir</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">data_dir</span>, <span class="st">".cyphr"</span>, <span class="st">"keys"</span>, <span class="va">h</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $user</span></span>
<span><span class="co">## [1] "root"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $host</span></span>
<span><span class="co">## [1] "8d8641327ce4"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $date</span></span>
<span><span class="co">## [1] "2024-03-18 05:40:11 UTC"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $pub</span></span>
<span><span class="co">## [2048-bit rsa public key]</span></span>
<span><span class="co">## md5: b5f2de69993b7bb18267822463a7c9ec</span></span>
<span><span class="co">## sha256: 33692f4bb39a23d5fef0e0e6a98e2cce91b1a3f0896554b0325f6ed15a541b5e</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $key</span></span>
<span><span class="co">##   [1] ae 07 d5 ff 3b c8 b6 40 51 45 73 13 76 19 27 4e 0f f6 eb c2 05 d2 a7 d4 b5</span></span>
<span><span class="co">##  [26] 07 0c 13 8f 97 e5 6f 08 82 e0 96 f5 6f 57 c5 10 3a bb 79 73 96 a9 48 a2 bd</span></span>
<span><span class="co">##  [51] 6e 50 34 f6 b6 16 ec 33 8d 4a fd 15 d6 64 51 6b 18 d9 04 68 9f da 4d b1 c4</span></span>
<span><span class="co">##  [76] a1 57 b5 65 30 10 cf 99 f3 50 21 8c 8a 85 0c e1 6f 34 7b 70 32 34 f7 4f 73</span></span>
<span><span class="co">## [101] aa e7 08 67 9a dd 8d c2 42 fb 93 8d 11 77 27 4b 82 64 ea 46 63 a6 6d af 5f</span></span>
<span><span class="co">## [126] 95 0c 32 80 8c 53 40 ae ed c7 12 e0 4a df b4 a8 f9 d7 e8 d7 5a 58 c7 10 b9</span></span>
<span><span class="co">## [151] 1e d5 62 8c e1 0c a8 25 e5 84 a8 61 66 44 03 19 a7 c9 7d be bb 1f fc 69 44</span></span>
<span><span class="co">## [176] 33 e0 24 f9 f5 98 8b 92 4a 40 dd 70 81 53 cd 06 06 38 d1 05 10 51 68 17 db</span></span>
<span><span class="co">## [201] ee a9 11 2c 7b 7a 26 0b d2 84 db 18 19 7c d2 a0 ce f2 08 9b 6e 52 cf 9c 2d</span></span>
<span><span class="co">## [226] 4a bd 13 ab 08 74 4c 2f 6e 6e c4 93 7a ef cc 4f 51 11 6a 35 09 60 5a 74 91</span></span>
<span><span class="co">## [251] d8 a1 10 35 09 cb</span></span></code></pre>
<p>You can see that the hash of the public key is the same as name of the stored file here (which is used to prevent collisions when multiple people request access at the same time).</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "33692f4bb39a23d5fef0e0e6a98e2cce91b1a3f0896554b0325f6ed15a541b5e"</span></span></code></pre>
<p>When a request is posted it is an RDS file with all of the above except for the <code>key</code> element, which is added during authorisation.</p>
<p>(Note that the verification relies on the package code not being attacked, and given R’s highly dynamic nature an attacker could easily swap out the definition for the verification function with something that always returns <code>TRUE</code>.)</p>
<p>When an authorised user creates the <code>data_key</code> object (which allows decryption of the data) <code>secret</code> will:</p>
<ul>
<li>read their private user key (probably from <code>~/.ssh/id_rsa</code>)</li>
<li>read the encrypted data key from the data directory (the <code>$key</code> element from the list above).</li>
<li>decrypt this data key using their user key to yield the the data symmetric key.</li>
</ul>
</div>
<div class="section level2">
<h2 id="limitations">Limitations<a class="anchor" aria-label="anchor" href="#limitations"></a>
</h2>
<p>In the Dropbox scenario, non-password protected keys will afford only limited protection. This is because even though the keys and data are stored separately on Dropbox, they will be in the same place on a local computer; if that computer is lost then the only thing preventing an attacker recovering the data is security through obscurity (the data would appear to be random junk but they will be able to run your analysis scripts as easily as you can). Password protected keys will improve this situation considerably as without a password the data cannot be recovered.</p>
<p>The data is not encrypted during a running R session. R allows arbitrary modification of code at runtime so this package provides no security from the point where the data can be decrypted. If your computer was compromised then stealing the data while you are running R should be assumed to be straightforward.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>

  

  

  </body>
</html>
